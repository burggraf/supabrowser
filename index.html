<!doctype html>

<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>PostgreSQL in the Browser</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm@4.19.0/css/xterm.css" />
    <script src="https://unpkg.com/xterm@4.19.0/lib/xterm.js"></script>
    <script src="./js/libv86.js"></script>
    <script src="./js/idb-storage.min.js"></script>
    <script>
        var emulator;
        let config = {
            font_size: 15,
            memory_size: 128,
            save_filename: "state.bin"
            // vga_memory_size: 2,
        }
        const storage = idbStorage.createIDBStorage({
            name: "state-storage",
            conflicAction: "replace"
        });

        window.onload = () => {
            const saved_config = localStorage.getItem('config');
            try {
                if (saved_config) {
                    config = JSON.parse(saved_config);
                    console.log('config loaded from localStorage', config);
                }
            } catch (err) {
                console.error('error restoring config from localStorage', err);
            }
            let memorysizeElement = document.getElementById("memorysize");
            memorysizeElement.value = config.memory_size;
            document.getElementById("fontsize").value = config.font_size;
            document.getElementById("save_filename").value = config.save_filename || "state.bin";
            const baseOptions = {
                wasm_path: "./js/v86.wasm",
                memory_size: config.memory_size * 1024 * 1024,
                filesystem: {
                    basefs: "filesystem/filesystem.json",
                    baseurl: "filesystem/",
                },
                screen_container: document.getElementById("screen_container"),
                serial_container_xtermjs: document.getElementById("terminal"),
                // network_relay_url: "wss://relay.widgetry.org/", // For non localhost: wss://relay.widgetry.org/
                network_relay_url: "ws://proxy.azabab.com/",
                preserve_mac_from_state_image: false,
                mac_address_translation: false,
                autostart: true,
                disable_keyboard: true,
                disable_mouse: true,
                disable_speaker: true,
                acpi: true,
            };

            const params = (new URL(document.location)).searchParams;
            const boot = params.get("boot") === "true";

            if (boot) {
                document.getElementById("screen_container").style = 'display:block';
                // document.getElementById("terminal").style = '';
            }

            const options = {
                ...baseOptions,
                ...(boot ? {
                    bzimage: {
                        url: "./filesystem/08679b15.bin"
                    },
                    cmdline: [
                        "rw",
                        "root=host9p rootfstype=9p",
                        "rootflags=version=9p2000.L,trans=virtio,cache=loose",
                        "quiet acpi=off console=ttyS0",
                        "tsc=reliable mitigations=off random.trust_cpu=on",
                        "nowatchdog page_poison=on",
                    ].join(" "),
                    bios: {
                        url: "./system/seabios.bin",
                    },
                    vga_bios: {
                        url: "./system/vgabios.bin",
                    },
                } : {
                    initial_state: {
                        url: "./state/state-" + config.memory_size + ".bin.zst"
                    }
                })
            };

            emulator = new V86Starter(options);

            if (boot) {
                // let the user watch the boot process
                document.getElementById("terminal").style = 'filter: none;';

                function handleBoot(line) {
                    console.log('handleBoot =>', line);
                    if (line.startsWith("server started")) {
                        emulator.remove_listener(handleBoot);
                        setTimeout(() => {
                            emulator.serial0_send('\\!/etc/init.d/S40network restart\n');
                            emulator.serial0_send('psql -U postgres\n');
                            emulator.serial0_send('\\! echo "boot_completed"; reset\n');
                            setTimeout(() => {
                                document.getElementById("terminal").style = 'filter: none;';
                                document.getElementById("screen_container").style =
                                    'display: none;';
                                emulator.serial_adapter.term.focus();
                            }, 2000);

                        }, 1000);
                    }
                }
                emulator.add_listener("serial0-output-line", handleBoot);
            } else {
                emulator.add_listener("emulator-ready", function () {
                    console.log("emulator ready!");
                    updateFontSize();

                    setTimeout(() => {
                        emulator.serial0_send('\\!/etc/init.d/S40network restart\n');
                        emulator.serial0_send('psql -U postgres\n');
                        emulator.serial0_send('\\! echo "boot_completed"; reset\n');
                    }, 0);
                    setTimeout(() => {
                        document.getElementById("terminal").style = 'filter: none;';
                    }, 2000);
                });
            }
            emulator.clearState = async function () {
                await storage.delete('state-' + config.memory_size);
            }

            emulator.save = async function () {
                await emulator.clearState();
                const state = await emulator.save_state();
                const meta = {};
                const result = await storage.set('state-' + config.memory_size, state, meta);
                console.log('save result', result);
            }
            emulator.restore = async function () {
                console.log('restoring from indexedDB', 'state-' + config.memory_size);
                storage.get('state-' + config.memory_size).then(function (state) {
                    if (state) {
                        const byteLength = state.byteLength;
                        // format byteLength with commas
                        var size = byteLength.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        console.log('state is', size, 'bytes');
                        emulator.stop();
                        emulator.restore_state(state).then(function (result) {
                            console.log('restore result', result);
                            emulator.run();
                            emulator.serial_adapter.term.focus();
                            // console.log('emulator.restore calling restart_network');
                            // restart_network();
                        }).catch(function (err) {
                            console.log(err);
                        });
                    } else {
                        console.log('no state to restore');
                    }
                }).catch(function (err) {
                    console.log('restore error', err);
                });
            }

            var state;

            // document.getElementById("save_restore").onclick = async function () {
            //     var button = this;

            //     if (state) {
            //         button.value = "Save state";
            //         await emulator.restore_state(state);
            //         state = undefined;
            //     } else {
            //         const new_state = await emulator.save_state();
            //         console.log("Saved state of " + new_state.byteLength + " bytes");
            //         button.value = "Restore state";
            //         state = new_state;
            //     }

            //     button.blur();
            // };

            document.getElementById("save_file").onclick = async function () {
                config.save_filename = document.getElementById("save_filename").value || "state.bin";
                console.log('config.save_filename', config.save_filename);
                const new_state = await emulator.save_state();
                var a = document.createElement("a");
                a.download = config.save_filename; //"v86state.bin";
                a.href = window.URL.createObjectURL(new Blob([new_state]));
                a.dataset.downloadurl = "application/octet-stream:" + a.download + ":" + a.href;
                a.click();

                this.blur();
                localStorage.setItem('config', JSON.stringify(config));

            };

            document.getElementById("restore_file").onchange = function () {
                if (this.files.length) {
                    var filereader = new FileReader();
                    emulator.stop();

                    filereader.onload = async function (e) {
                        await emulator.restore_state(e.target.result);
                        emulator.run();
                    };

                    filereader.readAsArrayBuffer(this.files[0]);

                    this.value = "";
                }

                this.blur();
            };



            document.getElementById("upload_files").onchange = function (e) {
                console.log('upload_files', e.target.files);
                async function getAsByteArray(file) {
                    return new Uint8Array(await readFile(file))
                }

                function readFile(file) {
                    return new Promise((resolve, reject) => {
                        // Create file reader
                        let reader = new FileReader()
                        // Register event listeners
                        reader.addEventListener("loadend", e => resolve(e.target.result))
                        reader.addEventListener("error", reject)
                        // Read file
                        reader.readAsArrayBuffer(file)
                    })
                }
                var files = e.target.files;
                for (var i = 0; i < files.length; i++) {
                    var reader = new FileReader();
                    reader.onload = function (file) {
                        return async function (e) {
                            const byteFile = await getAsByteArray(file);
                            emulator.create_file("/INBOX/" + file.name, byteFile);
                            console.log("uploaded " + file.name);
                        }
                    }(files[i]);
                    //reader.readAsText(files[i]);
                    reader.readAsArrayBuffer(files[i]);
                }
            }

            document.getElementById("read_file").onclick = async function () {
                const path = document.getElementById("read_file_name").value;
                const contents = await emulator.read_file(path);
                const filename = ('/' + path).split('/').pop();
                var a = document.createElement("a");
                a.download = filename;
                a.href = window.URL.createObjectURL(new Blob([contents]));
                // image/png
                // application/octet-stream
                a.dataset.downloadurl = "application/octet-stream:" + a.download + ":" + a.href;
                a.click();
                a.remove();
            }

        };

        function updateFontSize() {
            console.log('FONT SIZE WAS', emulator.serial_adapter.term.options.fontSize);
            //emulator.screen_adapter.set_size_text(document.getElementById("font_size").value, document.getElementById("font_size").value);
            try {
                config.font_size = parseInt(document.getElementById("fontsize").value, 10) || 14;
                if (config.font_size < 4 || config.font_size > 90) {
                    config.font_size = 15;
                }
            } catch (err) {
                console.log('error parsing font size', err);
                config.font_size = 15;
            }
            emulator.serial_adapter.term.options.fontSize = config.font_size;
            if (emulator.serial_adapter.term.element && emulator.serial_adapter.term.element.children[0]) {
                //emulator.serial_adapter.term.element.children[0].style.width = 0;
                emulator.serial_adapter.term.element.children[0].style.backgroundColor = 'white';
                localStorage.setItem('config', JSON.stringify(config));
            } else {
                console.log('terminal not initialized, cannot update find size yet');
            }
        }

        function updateMemorySize() {
            const fullboot = document.getElementById("fullboot").checked;
            const newMemorySize = document.getElementById("memorysize").value;
            try {
                config.memory_size = parseInt(newMemorySize, 10) || 96;
                if (!config.memory_size || config.memory_size < 96) {
                    config.memory_size = 96;
                    document.getElementById("memorysize").value = config.memory_size;
                }
                localStorage.setItem('config', JSON.stringify(config));
                // get current url of window
                let url = window.location.origin;
                if (fullboot) {
                    url += '?boot=true';
                }
                window.location = url;
            } catch (e) {
                console.log('updateMemorySize error', e);
            }
        }
        
        function sendText() {

            emulator.add_listener("serial1-output-char", function(char)
            {
                console.log("outchar1", char);
            });

            const text = document.getElementById("textarea").value;
            // emulator.serial0_send(text);
            // net0-send
            console.log('emulator', emulator);
            console.log('emulator.bus', emulator.bus);
            //console.log('emulator.network_adapter', emulator.network_adapter.bus);
            console.log('sending text', text);
            // console.log('emulator.keyboard_send_text', emulator.keyboard_send_text);
            // emulator.keyboard_send_text(text);
            let arr = [];
            for (let x = 0; x < text.length; x++) {
                arr.push(text.charCodeAt(x));
            }
            emulator.bus.listeners.net0-send(arr);

            // emulator.serial_send_bytes("1",arr);
            // emulator.bus.send("serial1-input", arr);

            // console.log("hello,world".charCodeAt(0))
            // document.getElementById("textarea").value = "";
        }
    </script>
</head>

<body>

    <div id="screen_container" style="display:none">
        <div></div>
        <canvas></canvas>
        <hr />
    </div>
    <div id="terminal" style="filter: blur(3px);"></div>
    <hr />
    <div style="clear: both;">
        <!-- <input id="save_restore" type="button" value="Save state"> -->
        <input id="save_file" type="button" value="Save state to file:">
        <input type="text" id="save_filename" value="" placeholder="enter filename">
        &nbsp;&nbsp;

        <button style="display:inline;width:160px; height:20px;"
            onclick="document.getElementById('restore_file').click()">
            Restore state from file
        </button>
        <input type='file' id="restore_file" style="display:none">

        <br />
        <button onclick="emulator.save()">Save to IndexedDB</button>&nbsp;&nbsp;
        <button onclick="emulator.restore()">Restore from IndexedDB</button>&nbsp;&nbsp;
        <button onclick="emulator.clearState()">Clear IndexedDB</button>
        <br />
        <input type="text" id="fontsize" value="15" min="4" max="40" style="width: 25px">&nbsp;&nbsp;<button
            onclick="updateFontSize()">Update font size</button>
        <br />
        memory (mb): <select name="memorysize" id="memorysize">
            <option value="128">128</option>
            <option value="196">196</option>
            <option value="256">256</option>
            <option value="384">384</option>
            <option value="512">512</option>
            <option value="1024">1024</option>
        </select>
        <!-- <input type="text" id="memorysize" value="96" min="96" max="8192" style="width: 35px">-->&nbsp;&nbsp;<button
            onclick="updateMemorySize()">Reset</button>
        &nbsp;&nbsp;<input type="checkbox" id="fullboot" name="fullboot" value="true"> Full Boot
        <br />
        <button style="display:inline;width:160px; height:20px;"
            onclick="document.getElementById('upload_files').click()">
            Send files to emulator
        </button>
        <input type='file' id="upload_files" style="display:none" multiple>

        &nbsp;&nbsp;

        <button style="display:inline;width:110px; height:20px;" id="read_file">
            Download file
        </button>
        <input type="text" id="read_file_name" value="" placeholder="enter path to file">
        <br /><hr />
        <textarea id="textarea" cols="55" rows="10" style="width: 100%"></textarea><br>
        <button onclick="sendText()">Send Text</button>
    </div>
</body>